<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>WebSocket Video Player</title>
  <style>
    body { background: #000; margin: 0; display: flex; justify-content: center; align-items: center; height: 100vh; }
    video { width: 90%; border: 3px solid #fff; border-radius: 10px; }
  </style>
</head>
<body>

<video id="video" controls autoplay muted></video>

<script>
  const video = document.getElementById('video');
const mediaSource = new MediaSource();
video.src = URL.createObjectURL(mediaSource);

let sourceBuffer;
let ws;
let queue = [];

mediaSource.addEventListener('sourceopen', () => {
  console.log('MediaSource opened');

  if (mediaSource.readyState !== 'open') {
    console.warn('MediaSource not open, skipping...');
    return;
  }

  try {
    sourceBuffer = mediaSource.addSourceBuffer('video/mp4; codecs="avc1.42E01E , mp4a.40.2"');
  } catch (e) {
    console.error("addSourceBuffer error:", e);
    return;
  }

  sourceBuffer.mode = 'segments';

  ws = new WebSocket("ws://localhost:8000/ws/video/?id=4&quality=360");
  ws.binaryType = "arraybuffer";

  ws.onmessage = (event) => {
    if (!sourceBuffer || mediaSource.readyState !== 'open') {
      console.warn('Skipping chunk because sourceBuffer is not ready');
      return;
    }

    const chunk = new Uint8Array(event.data);
    if (sourceBuffer.updating || queue.length > 0) {
      queue.push(chunk);
    } else {
      try {
        sourceBuffer.appendBuffer(chunk);
      } catch (e) {
        console.error("Append error:", e);
      }
    }
  };

  sourceBuffer.addEventListener('updateend', () => {
    if (queue.length > 0 && !sourceBuffer.updating) {
      sourceBuffer.appendBuffer(queue.shift());
    }
  });

  ws.onclose = () => console.log('WebSocket closed');
  ws.onerror = err => console.error('WebSocket error:', err);
});

mediaSource.addEventListener('error', e => {
  console.error('MediaSource error:', e);
});

mediaSource.addEventListener('sourceended', () => {
  console.log('MediaSource ended');
});

</script>

</body>
</html>
