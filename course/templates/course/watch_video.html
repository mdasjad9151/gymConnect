<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Video Stream</title>
  </head>
  <body>
    <video id="videoPlayer" controls autoplay width="640" height="360"></video>

    <script>
      const video = document.getElementById("videoPlayer");
      const socket = new WebSocket(
        "ws://localhost:8000/ws/video/?id={{ video.id }}&quality=360"
      );
      socket.binaryType = "arraybuffer";

      const mediaSource = new MediaSource();
      video.src = URL.createObjectURL(mediaSource);
    
      console.log(video.src)
      console.log(mediaSource)

      let sourceBuffer;
      let bufferQueue = [];

      mediaSource.addEventListener("sourceopen", () => {
        const mime = 'video/mp4; codecs="avc1.42E01E"';

        console.log(
          "MIME Supported:",
          MediaSource.isTypeSupported(
            'video/mp4; codecs="avc1.64001E, mp4a.40.2"'
          )
        );

        if (!MediaSource.isTypeSupported(mime)) {
          console.error("MIME type not supported");
          return;
        }

        sourceBuffer = mediaSource.addSourceBuffer(mime);
        sourceBuffer.mode = "sequence";
        console.log(sourceBuffer)

        sourceBuffer.addEventListener("updateend", () => {
          if (bufferQueue.length && !sourceBuffer.updating) {
            sourceBuffer.appendBuffer(bufferQueue.shift());
          }
        });

       socket.onmessage = (event) => {
  if (event.data instanceof ArrayBuffer) {
    const chunk = new Uint8Array(event.data);
    console.log("Received chunk size:", chunk.byteLength);
    try {
      if (!sourceBuffer.updating) {
        console.log("Appending chunk to sourceBuffer");
        sourceBuffer.appendBuffer(chunk);
      } else {
        console.log("Buffer is updating, queuing chunk");
        bufferQueue.push(chunk);
      }
    } catch (err) {
      console.error("Buffer append error:", err);
      if (err.name === "InvalidStateError" && mediaSource.readyState === "open") {
        try {
          console.log("Aborting sourceBuffer");
          sourceBuffer.abort();
          bufferQueue = [];
        } catch (abortErr) {
          console.error("Abort error:", abortErr);
        }
      }
    }
  } else {
    console.log("Text message:", event.data);
  }
};

        socket.onopen = () => console.log("WebSocket connected");
        socket.onerror = (e) => console.error("WebSocket error", e);
        socket.onclose = () => console.log("WebSocket closed");
      });

      video.addEventListener("error", (e) => {
        console.error("Video error:", video.error, e);
      });
    </script>
  </body>
</html>
